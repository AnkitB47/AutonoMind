name: ðŸš€ CI/CD - Deploy GPU Agent to RunPod

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy-gpu:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ›  Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: ðŸ” Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USER }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: ðŸ§± Build & Push GPU Docker Image
        run: |
          docker build -f docker/Dockerfile.gpu -t ghcr.io/${{ secrets.GHCRL_USER }}/autonomind-gpu:latest .
          docker push ghcr.io/${{ secrets.GHCRL_USER }}/autonomind-gpu:latest

      - name: ðŸš€ Launch RunPod GPU Instance from Pod Template
        id: launch
        run: |
          response=$(curl -s -X POST https://api.runpod.io/pod \
            -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "templateId": "uhqe2m9jvy",
              "name": "AutonoMind GPU Agent"
            }')

          echo "Launch response: $response"
          pod_id=$(echo "$response" | jq -r '.podId')
          echo "RUNPOD_POD_ID=$pod_id" >> $GITHUB_ENV

      - name: ðŸ”„ Poll for Pod Readiness & Store Endpoint
        run: |
          for i in {1..30}; do
            status_response=$(curl -s -X POST https://api.runpod.io/pod/status \
              -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"podId\": \"${{ env.RUNPOD_POD_ID }}\"}")

            status=$(echo "$status_response" | jq -r '.status')
            echo "â³ Pod status: $status"

            if [ "$status" = "RUNNING" ]; then
              url=$(echo "$status_response" | jq -r '.endpoint')
              echo "âœ… Live RunPod URL: $url"
              echo "RUNPOD_URL=$url" >> $GITHUB_ENV
              gh secret set RUNPOD_URL -b"$url"
              break
            fi

            sleep 10
          done
