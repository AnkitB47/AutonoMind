name: üöÄ CI/CD - Deploy GPU Agent to RunPod

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy-gpu:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v3

      - name: üõ† Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: üîê Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USER }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: üß± Build & Push GPU Docker Image
        run: |
          docker build -f docker/Dockerfile.gpu -t ghcr.io/${{ secrets.GHCRL_USER }}/autonomind-gpu:latest .
          docker push ghcr.io/${{ secrets.GHCRL_USER }}/autonomind-gpu:latest

      - name: üöÄ Launch RunPod Pod from Template
        id: launch
        run: |
          response=$(curl -s -X POST https://api.runpod.ai/v2/uhqe2m9jvy/run \
            -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}')

          echo "Launch response: $response"
          pod_id=$(echo "$response" | jq -r '.id')
          echo "RUNPOD_POD_ID=$pod_id" >> $GITHUB_ENV

      - name: üîÑ Poll for Pod Readiness & Store Endpoint
        run: |
          for i in {1..30}; do
            status_response=$(curl -s -X POST https://api.runpod.ai/v2/uhqe2m9jvy/status \
              -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"id\": \"${{ env.RUNPOD_POD_ID }}\"}")

            # Check if it's a valid JSON object
            echo "üß™ Raw status response: $status_response"
            if echo "$status_response" | jq -e . >/dev/null 2>&1; then
              status=$(echo "$status_response" | jq -r '.status')
              echo "‚è≥ Pod status: $status"

              if [ "$status" = "RUNNING" ]; then
                url=$(echo "$status_response" | jq -r '.endpoint')
                echo "‚úÖ Live RunPod URL: $url"
                echo "RUNPOD_URL=$url" >> $GITHUB_ENV
                gh secret set RUNPOD_URL -b"$url"
                break
              fi
            else
              echo "‚ùå Invalid JSON response: $status_response"
            fi

            sleep 10
          done
