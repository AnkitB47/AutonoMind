# --- .github/workflows/deploy.yml ---
name: ðŸš€ CI/CD - Deploy to Fly.io (CPU)

on:
  push:
    branches: [main]

jobs:
  deploy-cpu:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Lint Python Code
        run: |
          pip install flake8
          flake8 . --exclude=.venv,docker

      - name: Run Basic Unit Tests
        run: |
          pip install -r requirements-cpu.txt
          python3 -m unittest discover tests

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Log in to Fly.io
        run: flyctl auth token "$FLY_API_TOKEN"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Build and Deploy Docker Image to Fly.io (CPU)
        run: flyctl deploy --dockerfile docker/Dockerfile.cpu